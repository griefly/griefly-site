// ZOMBULAR ed. 11, 2017-04-30, ML
// Copyright Profit-Audit @ 2016-2017

define(['./cito','./utils'],function(a,b){function e(o,p,q){return[].concat(...o.map(r=>p(r,q)))}function g(o,p){if(0!==o&&!o)return[];if('string'==typeof o)return[o];if('function'==typeof o)return g(o(p),p);if('object'==typeof o){if(Array.isArray(o))return e(o,g,p);var q=[];for(k in o)o.hasOwnProperty(k)&&b.val(o[k])&&q.push(k);return q}return[o+'']}function h(o,p){if(o=b.val(o,p),'string'==typeof o){if('<'===o||'!'===o)return{tag:o};if(''===o)return{};o={is:o}}if('object'!=typeof o)return{};o.is=b.val(o.is,p);var q={tag:'div',attrs:{},events:{}},r=[],s=/(^([0-9a-z\-_]+)|[<!])|([#\.]?[0-9a-z\-_]+)/gi;for(var t in o.is&&(o.is.match(s)||[]).forEach(function(w){'.'==w.charAt(0)?r.push(w.substr(1)):'#'==w.charAt(0)?q.attrs.id=w.substr(1):q.tag=w}),o)if(o.hasOwnProperty(t)&&'is'!==t)if('on'===t.substr(0,2)&&o[t])q.events[t.substr(2)]=o[t];else{var u=b.val(o[t],p);if(void 0===u)continue;'key'===t?q.key=u:'class'===t?r=r.concat(g(u,p)):q.attrs[t]=u}return 0<r.length&&(q.attrs['class']=r.join(' ')),q}function i(o,p){return void 0===o||null===o?'':'number'==typeof o?o+'':'function'==typeof o?i(o(p),p):Array.isArray(o)?e(o,i,p):o}return Object.assign(function(o,...p){return function(q){var r=h(o,q);return r.children=i(p,q),r}},{node:function(o,p){function q(x,y={}){t=Object.assign(t,y);var A=!1;'function'==typeof x?s.push(x):!0===x&&(A=!0),u||w(A)}var r,s=[],t={update:q},u=!1,w=b.throttled(0,function(){u=!0,r?a.vdom.update(r,p(t)):r=a.vdom.append(o,p(t)),b.callQueue(s),t={update:q},u=!1});return w(!0),{vnode:r,update:q,set:x=>p=x}},Val:function(o){var p=()=>o;return p.get=p,p.set=q=>o=q,p},Ref:function(o,p){var q=()=>o[p];return q.get=q,q.set=r=>o[p]=r,q}})});
